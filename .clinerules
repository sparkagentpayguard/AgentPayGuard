# Agent 工作约束（必读）

本文档规定了对 AI Assistant (Copilot) 在本项目中的行为约束。所有约束都版本控制在仓库中，确保跨会话一致性。

---

## 安全约束

### 1. 禁止读取敏感文件
- ✗ 拒绝读取任何 `.env*` 文件（包括 `.env.local`, `.env.production` 等）
- ✗ 拒绝读取包含私钥/API 密钥的任何文件
- 理由：保护私钥和敏感凭证
- 执行方式：基于**文件名黑名单**，不依赖用户提醒

### 2. 不修改安全政策
- ✗ 不修改或删除 `SECURITY.md`（除非经用户明确要求）
- ✗ 不删除 `AGENT_CONSTRAINTS.md`
- 理由：安全政策是版本控制的约束，不应被工作过程改动
- 审查：每个 git commit 前检查这两个文件是否被意外修改

### 3. 代码提交前必须验证
- ✗ 不提交未通过 `pnpm typecheck` 的代码
- ✗ 不提交未通过 `pnpm demo:pay` 和 `pnpm demo:reject` 验证的代码
- 理由：防止引入编译错误或运行时崩溃
- 执行：每次代码修改后，自动运行验证

---

## 工作流约束

### 4. 实时更新工作日志
- ✓ **每个 Phase（阶段）完成后，立即更新 AGENT_WORKLOG.md**
  - Phase 定义：一个独立的功能模块或问题解决
  - 内容：背景、实现步骤、文件变更、验证结果
- ✓ 每次 git commit 都应有对应的日志条目
- ✗ 不能说"我会等合适的时机再更新"（那个时机通常不会来）
- 理由：跨会话连续性；新 Agent 可从日志快速恢复项目状态

### 5. 清晰的 Git 提交
- ✓ 每个 commit message 包含：Phase 号 + 操作描述
- ✓ 示例：`Phase 12: Create TESTING_GUIDE.md for Role B test procedures`
- ✓ 一个 commit 对应一个完整功能（不打包多个无关变更）
- ✗ 不能有"WIP"或"temp"这样的模糊 commit
- 理由：便于回溯和代码审查

### 6. 任务追踪
- ✓ 复杂的多步骤工作（3+ 步）应使用 `manage_todo_list` 工具
- ✓ 显式标记 TODO 状态：not-started → in-progress → completed
- ✗ 不能同时标记多个 TODO 为 in-progress
- 理由：防止遗漏任务；提供工作可见性

---

## 代码质量约束

### 7. TypeScript 严格模式
- ✓ 所有 `.ts` 文件必须通过 `pnpm typecheck` （0 errors）
- ✗ 不使用 `any` 类型（除非别无选择，需注释说明）
- ✗ 不提交有编译警告的代码
- 理由：捕获类型错误，提高代码可靠性

### 8. Demo 脚本必须工作
- ✓ `pnpm demo:pay` 必须执行成功（干运行模式）
- ✓ `pnpm demo:reject` 必须显示预期的拒绝输出
- ✗ 修改代码后必须重新验证这两个命令
- 理由：这两个脚本是评委验证功能的第一步

### 9. 不破坏现有功能
- ✓ 重构代码时，必须保证已通过的测试仍然通过
- ✗ 不能为了简化某个部分而删除另一个工作的功能
- 理由：保持项目的可用性和可信度

---

## 决策约束

### 10. 重要决定需确认
- ✓ 架构变更、大的重构、删除代码前，询问用户意见
- ✓ 示例：修改 `src/lib/kite-aa.ts` 的核心逻辑
- ✗ 不能武断决定项目的关键方向
- 理由：确保 Agent 的行动与用户的意图一致

### 11. 文档控制
- ✓ 创建新文档时，询问是否真正需要（防止文档爆炸）
- ✗ 不创建冗余或一次性的文档
- ✓ 文档应该简洁、有单一的目的，且易维护
- 理由：用户的时间宝贵；过多文档增加维护负担

### 12. 设计决策文档化
- ✓ 任何非平凡的技术决策都应在适当的文件中记录
- ✓ 示例：为什么使用 AA 而不是直接转账？→ ARCHITECTURE.md
- ✗ 不能只在对话中说明，然后期望下个会话记得
- 理由：知识库应该是版本控制的，不是对话历史

---

## 项目结构约束

### 13. 不移动或删除核心文件
- ✗ 不删除 `src/lib/kite-aa.ts`, `src/lib/policy.ts` 等实现文件
- ✗ 不将核心逻辑迁移到不同的路径（除非充分重构）
- ✓ 如果需要重组，先更新 allocation.md 的交互点描述
- 理由：保持项目结构的稳定性

### 14. 环境变量范式
- ✓ 所有配置都应有对应的 `.env.example` 条目
- ✗ 不引入未在模板中记录的新环境变量
- ✓ 修改 `.env.example` 后更新 TESTING_GUIDE.md
- 理由：确保新用户知道需要配置什么

---

## 交流约束

### 15. 清晰的进度反馈
- ✓ 复杂任务完成后，总结：已完成、待处理、有依赖
- ✓ 示例：见 DELIVERY_SUMMARY.md 风格
- ✗ 不给出模糊的"差不多了"这样的反馈
- 理由：用户需要明确知道项目的真实状态

### 16. 链接文件时使用 Markdown
- ✓ 参考文件时使用 `[SECURITY.md](SECURITY.md)` 格式
- ✓ 参考特定行时使用 `[Line 42](SECURITY.md#L42)` 格式
- ✗ 不使用反引号包装文件名
- 理由：方便用户点击跳转

---

## 例外处理

### 何时可以违反上述约束

只有在以下情况下可以请求修改约束：

1. **用户明确要求** - "请修改约束 #X，改为..."
2. **约束导致严重阻碍** - 并且没有替代方案
3. **安全风险** - 约束本身包含安全漏洞

**流程**：
- Agent 提出修改建议
- 用户批准
- 更新 `AGENT_CONSTRAINTS.md` 的相应约束
- Git commit 说明变更原因

---

## 自检清单

在每个主要工作阶段完成后，检查以下项目：

- [ ] AGENT_WORKLOG.md 已更新新 Phase
- [ ] `pnpm typecheck` 返回 0 errors
- [ ] `pnpm demo:pay` 和 `pnpm demo:reject` 工作正常
- [ ] 没有新增或修改 `.env*` 文件
- [ ] Git commit message 清晰明确
- [ ] 所有新文件都有明确的目的
- [ ] SECURITY.md 和本文件 (AGENT_CONSTRAINTS.md) 未被修改
- [ ] 重要决定已文档化
- [ ] 依赖关系已在 allocation.md 中记录

---

## 更新历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-01-30 | 1.0 | 初版，16 条约束 |

---

**最后审核**：2026-01-30
**作者**：AI Assistant (Copilot)
**批准**：User


# 安全政策 (Security Policy)

本文档规定了 AgentPayGuard 项目的安全规则和最佳实践。

---

## 🔐 关键规则

### 1. 禁止共享敏感信息

**禁止的行为**：
- ❌ 在 Git 或任何版本控制中提交 `.env` 文件
- ❌ 在代码审查、Issue、PR 中分享私钥
- ❌ 向 AI Assistant 或任何外部工具提供 `.env` 内容
- ❌ 在讨论、文档、日志中暴露真实的 RPC 密钥、API Key
- ❌ 在截图或录屏中显示私钥信息

**敏感信息清单**：
- `PRIVATE_KEY` - 钱包私钥
- `MNEMONIC` - 助记词（如有）
- `API_KEY` - 任何 API 密钥
- `RPC_URL` - 内网或付费 RPC 端点（如有限制）
- `.env` 及其所有变体（`.env.local`、`.env.production` 等）

---

## ✅ 安全做法

### 配置管理

```bash
# 1. 确保 .env 在 .gitignore
echo ".env" >> .gitignore
echo ".env.local" >> .gitignore
echo ".env.*.local" >> .gitignore

# 2. 设置文件权限（仅所有者可读写）
chmod 600 .env

# 3. 使用 .env.example 作为公开模板
cp .env .env.example
# 然后编辑 .env.example，替换所有敏感值为占位符
```

### 与 AI Assistant 的交互

**安全交互方式**：
- ✅ 只讨论 `.env.example`（无真实数据）
- ✅ 描述需要什么字段和格式
- ✅ 讨论代码逻辑，不涉及实际值
- ✅ 如果需要共享配置，用占位符：`0x<ADDRESS>`、`sk_<KEY>`、`https://...`

**不安全的做法**：
- ❌ 复制粘贴 `.env` 内容给 AI
- ❌ 在聊天中分享真实私钥
- ❌ 上传包含 `.env` 的项目快照

---

## 🚫 AI Assistant 规则

### 自动安全防护

我（AI Assistant）承诺：
- **永不读取** 任何 `.env*` 文件（基于文件名匹配）
- **自动拒绝** 对敏感文件的任何读取请求
- **提醒用户** 安全规则和最佳实践
- **不存储** 任何私钥或密钥信息

### 文件名黑名单

以下文件我不会主动读取或处理，即使被明确要求：
```
.env
.env.local
.env.*.local
.env.production
.env.staging
.env.test
.env.development
```

---

## 📋 预检清单（Pre-Commit）

在提交代码前，运行以下检查：

```bash
# 1. 检查 .env 是否被意外暴露
git diff --cached | grep -i "private_key\|api_key\|secret"

# 2. 确认 .env 在 .gitignore 中
grep -E "^\.env" .gitignore

# 3. 确认文件权限
ls -la .env | grep "^-rw-------"  # 应该显示 600

# 4. 确认没有提交敏感文件
git ls-files | grep "\.env"  # 应该无输出
```

---

## 🔔 如果你发现敏感信息被泄露

**立即行动**：

1. **停止使用该密钥**
   ```bash
   # 如果是钱包私钥，立即转移资金到安全钱包
   # 如果是 API Key，立即轮换或删除
   ```

2. **从 Git 历史中移除**
   ```bash
   # 使用 git-filter-branch 或 BFG Repo-Cleaner
   # 这是高级操作，谨慎执行
   ```

3. **通知团队**
   - 告知所有对项目有访问权限的人
   - 更新所有备份和克隆

4. **更新文档**
   - 在 SECURITY.md 中记录事件
   - 增强安全检查

---

## 🛡️ 环境变量加载（安全方式）

**推荐做法**：

```typescript
// src/lib/config.ts - 只在运行时加载，不在构建时
import dotenv from 'dotenv';

dotenv.config();  // 从 .env 加载

const config = {
  privateKey: process.env.PRIVATE_KEY!,
  rpcUrl: process.env.RPC_URL!,
  // ... 其他配置
};

// ❌ 永远不要导出 config，只在内部使用
// ❌ 永远不要在日志中打印 config
export async function getSigner() {
  // config 在此函数内使用，不暴露给外部
  return new ethers.Wallet(config.privateKey, provider);
}
```

---

## 📝 代码审查检查清单

Reviewer 应该检查：

- [ ] 是否有新的 `.env*` 文件被提交
- [ ] 是否在代码中硬编码了私钥
- [ ] 是否在日志、错误消息中暴露敏感信息
- [ ] `.env.example` 是否已更新且无真实数据
- [ ] 是否有 `PRIVATE_KEY`、`API_KEY` 等敏感词出现在非 `.env` 文件中

---

## 📚 参考资源

- [Git 安全最佳实践](https://git-scm.com/book/en/v2/Git-Tools-Signing-Your-Work)
- [OWASP - Secrets Management](https://owasp.org/www-community/attacks/Key_Management)
- [ethers.js - 安全实践](https://docs.ethers.org/v6/getting-started/)

---

## 版本历史

| 日期 | 更新内容 |
|:---|:---|
| 2026-01-30 | 初版：添加 AI Assistant 安全规则、文件名黑名单 |

---

**所有团队成员都应该阅读并遵守本文档。** ⚠️

如有任何安全相关问题，请立即上报。
