# AgentPayGuard：面向 AI Agent 的链上支付权限与风控（Kite Payment Track）

本项目目标：让 AI Agent 在执行链上稳定币支付时，具备**可验证身份、可编程权限、可审计记录、可阻断异常**的最小闭环。

---

## 评委 1 分钟判定（赛道最低要求对照）

> 说明：下表是“是否进入评审”的硬门槛对照。占位信息（如 tx hash）请在提交前替换为真实数据。

| 赛道要求 | 本项目如何满足 | 证据/位置 |
| --- | --- | --- |
| 链上支付 | 完成 1 笔测试网稳定币转账（由 Agent 触发） | **Tx Hash**：`0x5a8c9e2d3b1f4a6c8e2d9b1c3e5f7a9c1b3d5e7f9a1b3c5d7e9f1a3b5c7d9e1f` |
| Agent 身份 | 使用 Kite 的 Agent/Passport（或官方身份体系）生成/绑定 Agent 身份 | 日志/截图：`docs/` 或演示视频 |
| 权限控制 | 至少 1 条可验证的支付规则（如白名单/限额/有效期）在支付前被强制校验 | `Policy` 配置 + 拒绝案例 |
| 可复现性 | 提供完整运行说明，一键跑通 “创建 Agent → 发起支付 → 成功到账/被拒绝” | `README.md` / 本文“运行与复现” |

---

## 项目解决的问题

AI Agent 一旦开始“真花钱”，系统立刻出现三个现实问题：

1. **谁在花钱**：服务方与用户需要能验证“这是哪个 Agent、代表谁、在什么授权下”发起支付。
2. **能不能停得住**：Agent 被提示注入、私钥/会话泄露、行为异常时，需要在支付执行前或执行边界上被强制拦截。
3. **事后能不能说清**：需要可追溯的审计链路，回答“这笔钱为什么付、付给谁、谁批准、规则是否被遵守”。

---

## 我们做了什么（MVP 范围）

我们刻意收敛为“能跑通、能演示、能复现”的最小闭环，而不是宏大叙事：

- **Agent 身份（Kite）**：为 Agent 建立可验证身份（Agent/Passport），把“支付请求”与“身份/授权”绑定。
- **支付执行（Kite）**：通过 Kite 支付能力完成稳定币转账（测试网/真实网络均可），展示到账结果。
- **权限/风控（AgentPayGuard）**：在支付执行前强制执行最小规则集（白名单/限额/有效期等）。
- **兜底治理（Kite 多签）**：当触发高风险事件时，资金/权限进入多签流程（冻结/解冻/策略更新）。

---

## 与 Kite 官方能力对齐（我们用到什么）

| Kite 能力 | 本项目用法（MVP） | 证据/链接 |
| --- | --- | --- |
| Agent 身份系统（Agent / Passport） | 创建/加载 Agent 身份，并把支付请求与身份绑定，便于追溯与授权证明 | 按官方文档集成（提交时附截图/日志） |
| 账户抽象（AA SDK） | 为 Agent 创建/加载智能账户，让权限/执行更适合自动化场景 | `https://docs.gokite.ai/kite-chain/5-advanced/account-abstraction-sdk` |
| 多签钱包（Multisig） | 作为安全阀：冻结/解冻/策略更新等敏感操作由多签控制 | `https://docs.gokite.ai/kite-chain/5-advanced/multisig-wallet` |
| 稳定币支付（Stablecoin Payment） | 执行 1 笔稳定币链上转账（测试网/真实网），并展示到账 | 按官方文档集成（提交时附 tx hash） |

---

## 核心工作流（Demo 脚本，建议现场照念）

### Demo A：正常支付（证明“能付钱”）

1. 创建/加载 Agent 身份（Kite Agent/Passport）。
2. 创建/加载 Agent 的智能账户（AA）。
3. 配置策略（例：允许收款地址白名单 + 单笔上限）。
4. 触发一次支付：Agent 向白名单地址转账 `X` 稳定币。
5. 展示链上结果：交易成功 + 记录可追溯（贴 tx hash）。

**预期展示点**：有身份 → 有规则 → 有稳定币到账 → 有链上可查证据。

### Demo B：异常支付被阻断（证明“能拦住”）

1. 模拟异常：把收款地址换成非白名单地址，或把金额改成超过限额。
2. 再次触发支付。
3. 展示结果：支付被拒绝（失败原因明确），并记录一次“策略命中/拒绝”事件。

**预期展示点**：拦截发生在支付边界上，规则是可验证/可复现的。

### Demo C：多签兜底（证明“有人类可控的安全阀”）

1. 触发高风险状态（例如连续多次拒绝/可疑行为）后进入“冻结/暂停”模式。
2. 由多签成员执行解冻/调整策略/恢复服务。

---

## 技术架构（从身份到支付的最短链路）

```
User(授权/配置策略)
  └─ Agent（Kite 身份：Agent/Passport）
       └─ AA 智能账户（Kite AA SDK）
            └─ Policy Guard（白名单/限额/有效期…）
                 └─ Stablecoin Payment（链上转账）
                      └─ Audit Trail（链上可查 + 可选本地日志）

异常/高风险 → Multisig（Kite 多签）介入：冻结/解冻/策略更新
```

---

## 最小策略集（可验证、可复现）

本项目不追求“AI 风控模型”，而是先把**支付权限边界**做成可编程、可证明：

- **收款地址白名单**：只允许支付给预先登记的供应商/合约地址。
- **单笔上限**：每笔最多支付 `X`。
- **周期限额（可选）**：每日/每小时总额不超过 `Y`。
- **授权有效期（可选）**：超过有效期的支付请求自动失效。

> 这些规则的价值在于：评委可以当场改配置、复现“允许/拒绝”的差异，并在链上/日志中看到结果。

---

## 为什么一定要链上（给评委的 3 句话版本）

1. **链上合约能 enforce（强制执行）**：规则不是“建议”，而是支付边界的一部分，能被验证、难以绕过。
2. **链上天然可审计**：事后可以用链上证据回答“谁付了钱、付给谁、规则是否被遵守”。
3. **跨组织可共享信任**：当服务方、用户、审计方不在同一套中心化系统时，链上是共同可信的对账层。

---

## 运行与复现（提交时请补全为可一键运行）

> 目标：让评委按步骤跑通 Demo A/B（最好 5 分钟内完成）。

### 前置条件

- Node.js / pnpm（或你项目实际使用的环境）
- Kite 测试网 RPC 与测试币（按官方文档）
- 环境变量（按 `README.md` 补齐）：`RPC_URL`、`PRIVATE_KEY`、`AGENT_ID`、`PAY_TOKEN` 等

### 一键脚本（示例占位）

```bash
# 安装依赖
pnpm i

# Demo A：正常支付（输出 tx hash）
pnpm demo:pay

# Demo B：触发异常并被阻断（输出拒绝原因）
pnpm demo:reject
```

### 交付物清单（建议）

- 演示视频：包含 Demo A/B/C（可选但加分）
- 截图：展示策略配置、拒绝原因、链上交易页面（tx hash）
- README：从零到跑通（无脑跟做）

---

## 参考（仅官方/项目内）

- Kite 多签钱包文档：`https://docs.gokite.ai/kite-chain/5-advanced/multisig-wallet`
- Kite 账户抽象 SDK：`https://docs.gokite.ai/kite-chain/5-advanced/account-abstraction-sdk`
- Kite 白皮书（项目内）：`resources/kite_whitepaper.pdf`