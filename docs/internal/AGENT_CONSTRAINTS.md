# Agent 工作约束（必读）

本文档规定了对 AI Assistant (Copilot) 在本项目中的行为约束。所有约束都版本控制在仓库中，确保跨会话一致性。

---

## 安全约束

### 1. 禁止读取敏感文件
- ✗ 拒绝读取任何 `.env*` 文件（包括 `.env.local`, `.env.production` 等）
- ✗ 拒绝读取包含私钥/API 密钥的任何文件
- 理由：保护私钥和敏感凭证
- 执行方式：基于**文件名黑名单**，不依赖用户提醒

### 2. 不修改安全政策
- ✗ 不修改或删除 `SECURITY.md`（除非经用户明确要求）
- ✗ 不删除 `AGENT_CONSTRAINTS.md`
- 理由：安全政策是版本控制的约束，不应被工作过程改动
- 审查：每个 git commit 前检查这两个文件是否被意外修改

### 3. 代码提交前必须验证
- ✗ 不提交未通过 `pnpm typecheck` 的代码
- ✗ 不提交未通过 `pnpm demo:pay` 和 `pnpm demo:reject` 验证的代码
- 理由：防止引入编译错误或运行时崩溃
- 执行：每次代码修改后，自动运行验证

---

## 工作流约束

### 4. 实时更新工作日志
- ✓ **每个 Phase（阶段）完成后，立即更新 AGENT_WORKLOG.md**
  - Phase 定义：一个独立的功能模块或问题解决
  - 内容：背景、实现步骤、文件变更、验证结果
- ✓ 每次 git commit 都应有对应的日志条目
- ✗ 不能说"我会等合适的时机再更新"（那个时机通常不会来）
- 理由：跨会话连续性；新 Agent 可从日志快速恢复项目状态

### 5. 清晰的 Git 提交
- ✓ 每个 commit message 包含：Phase 号 + 操作描述
- ✓ 示例：`Phase 12: Create TESTING_GUIDE.md for Role B test procedures`
- ✓ 一个 commit 对应一个完整功能（不打包多个无关变更）
- ✗ 不能有"WIP"或"temp"这样的模糊 commit
- 理由：便于回溯和代码审查

### 6. 任务追踪
- ✓ 复杂的多步骤工作（3+ 步）应使用 `manage_todo_list` 工具
- ✓ 显式标记 TODO 状态：not-started → in-progress → completed
- ✗ 不能同时标记多个 TODO 为 in-progress
- 理由：防止遗漏任务；提供工作可见性

---

## 代码质量约束

### 7. TypeScript 严格模式
- ✓ 所有 `.ts` 文件必须通过 `pnpm typecheck` （0 errors）
- ✗ 不使用 `any` 类型（除非别无选择，需注释说明）
- ✗ 不提交有编译警告的代码
- 理由：捕获类型错误，提高代码可靠性

### 8. Demo 脚本必须工作
- ✓ `pnpm demo:pay` 必须执行成功（干运行模式）
- ✓ `pnpm demo:reject` 必须显示预期的拒绝输出
- ✗ 修改代码后必须重新验证这两个命令
- 理由：这两个脚本是评委验证功能的第一步

### 9. 不破坏现有功能
- ✓ 重构代码时，必须保证已通过的测试仍然通过
- ✗ 不能为了简化某个部分而删除另一个工作的功能
- 理由：保持项目的可用性和可信度

---

## 决策约束

### 10. 重要决定需确认
- ✓ 架构变更、大的重构、删除代码前，询问用户意见
- ✓ 示例：修改 `src/lib/kite-aa.ts` 的核心逻辑
- ✗ 不能武断决定项目的关键方向
- 理由：确保 Agent 的行动与用户的意图一致

### 11. 文档控制
- ✓ 创建新文档时，询问是否真正需要（防止文档爆炸）
- ✗ 不创建冗余或一次性的文档
- ✓ 文档应该简洁、有单一的目的，且易维护
- 理由：用户的时间宝贵；过多文档增加维护负担

### 12. 设计决策文档化
- ✓ 任何非平凡的技术决策都应在适当的文件中记录
- ✓ 示例：为什么使用 AA 而不是直接转账？→ ARCHITECTURE.md
- ✗ 不能只在对话中说明，然后期望下个会话记得
- 理由：知识库应该是版本控制的，不是对话历史

---

## 项目结构约束

### 13. 不移动或删除核心文件
- ✗ 不删除 `src/lib/kite-aa.ts`, `src/lib/policy.ts` 等实现文件
- ✗ 不将核心逻辑迁移到不同的路径（除非充分重构）
- ✓ 如果需要重组，先更新 allocation.md 的交互点描述
- 理由：保持项目结构的稳定性

### 14. 环境变量范式
- ✓ 所有配置都应有对应的 `.env.example` 条目
- ✗ 不引入未在模板中记录的新环境变量
- ✓ 修改 `.env.example` 后更新 TESTING_GUIDE.md
- 理由：确保新用户知道需要配置什么

---

## 交流约束

### 15. 清晰的进度反馈
- ✓ 复杂任务完成后，总结：已完成、待处理、有依赖
- ✓ 示例：见 DELIVERY_SUMMARY.md 风格
- ✗ 不给出模糊的"差不多了"这样的反馈
- 理由：用户需要明确知道项目的真实状态

### 16. 链接文件时使用 Markdown
- ✓ 参考文件时使用 `[SECURITY.md](SECURITY.md)` 格式
- ✓ 参考特定行时使用 `[Line 42](SECURITY.md#L42)` 格式
- ✗ 不使用反引号包装文件名
- 理由：方便用户点击跳转

---

## 例外处理

### 何时可以违反上述约束

只有在以下情况下可以请求修改约束：

1. **用户明确要求** - "请修改约束 #X，改为..."
2. **约束导致严重阻碍** - 并且没有替代方案
3. **安全风险** - 约束本身包含安全漏洞

**流程**：
- Agent 提出修改建议
- 用户批准
- 更新 `AGENT_CONSTRAINTS.md` 的相应约束
- Git commit 说明变更原因

---

## 自检清单

在每个主要工作阶段完成后，检查以下项目：

- [ ] AGENT_WORKLOG.md 已更新新 Phase
- [ ] `pnpm typecheck` 返回 0 errors
- [ ] `pnpm demo:pay` 和 `pnpm demo:reject` 工作正常
- [ ] 没有新增或修改 `.env*` 文件
- [ ] Git commit message 清晰明确
- [ ] 所有新文件都有明确的目的
- [ ] SECURITY.md 和本文件 (AGENT_CONSTRAINTS.md) 未被修改
- [ ] 重要决定已文档化
- [ ] 依赖关系已在 allocation.md 中记录

---

## 更新历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-01-30 | 1.0 | 初版，16 条约束 |

---

**最后审核**：2026-01-30
**作者**：AI Assistant (Copilot)
**批准**：User
